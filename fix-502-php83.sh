#!/bin/bash

# ‰∏ìÈó®ÈíàÂØπPHP 8.3-FPMÁöÑ502ÈîôËØØ‰øÆÂ§çËÑöÊú¨
# ÈÄÇÈÖçFastPanelÈù¢ÊùøÁöÑPHP 8.3-FPMÁéØÂ¢É

set -e

echo "üöÄ PHP 8.3-FPM‰∏ìÁî®502‰øÆÂ§ç"
echo "=========================="
echo "ÁõÆÊ†áÔºö‰øÆÂ§çFastPanel PHP 8.3-FPMÁéØÂ¢ÉÁöÑ502ÈîôËØØ"
echo ""

# È¢úËâ≤ÂÆö‰πâ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m'

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_step() {
    echo -e "${PURPLE}[STEP]${NC} $1"
}

# Ê£ÄÊü•ÊòØÂê¶‰∏∫rootÁî®Êà∑
if [ "$EUID" -ne 0 ]; then
    log_error "ËØ∑‰ΩøÁî® root Áî®Êà∑Êàñ sudo ËøêË°åÊ≠§ËÑöÊú¨"
    exit 1
fi

PROJECT_DIR="/var/www/besthammer_c_usr/data/www/besthammer.club"
PUBLIC_DIR="$PROJECT_DIR/public"

# Âõ∫ÂÆö‰ΩøÁî®PHP 8.3
PHP_VERSION="8.3"
PHP_SERVICE="php8.3-fpm"
PHP_SOCKET="/var/run/php/php8.3-fpm.sock"

log_step "Á¨¨1Ê≠•ÔºöÊ£ÄÊü•PHP 8.3-FPMÁä∂ÊÄÅ"
echo "-----------------------------------"

log_info "Ê£ÄÊü•FastPanelÁöÑPHP 8.3-FPMÈÖçÁΩÆ..."

# Ê£ÄÊü•PHP 8.3-FPMÊúçÂä°
if systemctl list-unit-files | grep -q "$PHP_SERVICE"; then
    log_success "ÂèëÁé∞PHP 8.3-FPMÊúçÂä°"
    
    # Ê£ÄÊü•ÊúçÂä°Áä∂ÊÄÅ
    if systemctl is-active --quiet "$PHP_SERVICE"; then
        log_success "PHP 8.3-FPMÊ≠£Âú®ËøêË°å"
    else
        log_warning "PHP 8.3-FPMÊú™ËøêË°åÔºåÊ≠£Âú®ÂêØÂä®..."
        systemctl start "$PHP_SERVICE"
        systemctl enable "$PHP_SERVICE"
    fi
    
    # ÈáçÂêØÊúçÂä°Á°Æ‰øùÁä∂ÊÄÅÊ≠£Â∏∏
    log_info "ÈáçÂêØPHP 8.3-FPMÊúçÂä°..."
    systemctl restart "$PHP_SERVICE"
    sleep 3
    
    if systemctl is-active --quiet "$PHP_SERVICE"; then
        log_success "PHP 8.3-FPMÈáçÂêØÊàêÂäü"
    else
        log_error "PHP 8.3-FPMÈáçÂêØÂ§±Ë¥•"
        systemctl status "$PHP_SERVICE"
        exit 1
    fi
else
    log_error "Êú™ÊâæÂà∞PHP 8.3-FPMÊúçÂä°"
    log_info "Â∞ùËØïÂÆâË£ÖPHP 8.3-FPM..."
    
    apt update
    apt install -y php8.3-fpm php8.3-mysql php8.3-xml php8.3-mbstring php8.3-curl php8.3-zip php8.3-gd php8.3-intl
    systemctl start "$PHP_SERVICE"
    systemctl enable "$PHP_SERVICE"
    log_success "PHP 8.3-FPMÂ∑≤ÂÆâË£Ö"
fi

log_step "Á¨¨2Ê≠•ÔºöÊ£ÄÊü•Âíå‰øÆÂ§çSocketÊñá‰ª∂"
echo "-----------------------------------"

# Ê£ÄÊü•socketÊñá‰ª∂
SOCKET_PATHS=(
    "/var/run/php/php8.3-fpm.sock"
    "/run/php/php8.3-fpm.sock"
)

ACTIVE_SOCKET=""
for socket in "${SOCKET_PATHS[@]}"; do
    if [ -S "$socket" ]; then
        log_success "ÊâæÂà∞socketÊñá‰ª∂: $socket"
        ACTIVE_SOCKET="$socket"
        break
    fi
done

if [ -z "$ACTIVE_SOCKET" ]; then
    log_error "Êú™ÊâæÂà∞PHP 8.3-FPM socketÊñá‰ª∂"
    log_info "Ê£ÄÊü•PHP-FPMÈÖçÁΩÆ..."
    
    # Ê£ÄÊü•PHP-FPMÈÖçÁΩÆÊñá‰ª∂
    PHP_POOL_CONFIG="/etc/php/8.3/fpm/pool.d/www.conf"
    if [ -f "$PHP_POOL_CONFIG" ]; then
        log_info "Ê£ÄÊü•poolÈÖçÁΩÆ: $PHP_POOL_CONFIG"
        grep "listen = " "$PHP_POOL_CONFIG" | head -1
    fi
    
    exit 1
else
    PHP_SOCKET="$ACTIVE_SOCKET"
fi

# Ê£ÄÊü•socketÊùÉÈôê
SOCKET_PERMS=$(stat -c '%a' "$PHP_SOCKET")
SOCKET_OWNER=$(stat -c '%U:%G' "$PHP_SOCKET")
log_info "SocketÊùÉÈôê: $SOCKET_PERMS ($SOCKET_OWNER)"

# ‰øÆÂ§çsocketÊùÉÈôê
chown www-data:www-data "$PHP_SOCKET"
chmod 660 "$PHP_SOCKET"
log_success "SocketÊùÉÈôêÂ∑≤‰øÆÂ§ç"

log_step "Á¨¨3Ê≠•Ôºö‰ºòÂåñPHP 8.3-FPMÈÖçÁΩÆ"
echo "-----------------------------------"

# ‰ºòÂåñPHP-FPM poolÈÖçÁΩÆ
PHP_POOL_CONFIG="/etc/php/8.3/fpm/pool.d/www.conf"

if [ -f "$PHP_POOL_CONFIG" ]; then
    log_info "‰ºòÂåñPHP 8.3-FPM poolÈÖçÁΩÆ..."
    
    # Â§á‰ªΩÈÖçÁΩÆ
    cp "$PHP_POOL_CONFIG" "${PHP_POOL_CONFIG}.backup.$(date +%Y%m%d_%H%M%S)"
    
    # Á°Æ‰øùÂÖ≥ÈîÆÈÖçÁΩÆÊ≠£Á°Æ
    sed -i 's/;listen.owner = www-data/listen.owner = www-data/' "$PHP_POOL_CONFIG"
    sed -i 's/;listen.group = www-data/listen.group = www-data/' "$PHP_POOL_CONFIG"
    sed -i 's/;listen.mode = 0660/listen.mode = 0660/' "$PHP_POOL_CONFIG"
    
    # ‰ºòÂåñËøõÁ®ãÁÆ°ÁêÜ
    sed -i 's/pm.max_children = .*/pm.max_children = 50/' "$PHP_POOL_CONFIG"
    sed -i 's/pm.start_servers = .*/pm.start_servers = 5/' "$PHP_POOL_CONFIG"
    sed -i 's/pm.min_spare_servers = .*/pm.min_spare_servers = 5/' "$PHP_POOL_CONFIG"
    sed -i 's/pm.max_spare_servers = .*/pm.max_spare_servers = 35/' "$PHP_POOL_CONFIG"
    
    log_success "PHP 8.3-FPMÈÖçÁΩÆÂ∑≤‰ºòÂåñ"
    
    # ÈáçÂêØPHP-FPMÂ∫îÁî®Êñ∞ÈÖçÁΩÆ
    systemctl restart "$PHP_SERVICE"
    sleep 2
fi

log_step "Á¨¨4Ê≠•ÔºöÂàõÂª∫PHP 8.3‰∏ìÁî®NginxÈÖçÁΩÆ"
echo "-----------------------------------"

# ÂàõÂª∫ÈíàÂØπPHP 8.3‰ºòÂåñÁöÑNginxÈÖçÁΩÆ
NGINX_CONFIG="/etc/nginx/sites-available/besthammer.club"

cat > "$NGINX_CONFIG" << EOF
# PHP 8.3-FPM‰∏ìÁî®NginxÈÖçÁΩÆ
server {
    listen 80;
    listen [::]:80;
    server_name besthammer.club www.besthammer.club;
    
    # CloudflareÁúüÂÆûIP
    real_ip_header CF-Connecting-IP;
    set_real_ip_from 0.0.0.0/0;
    
    return 301 https://\$server_name\$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name besthammer.club www.besthammer.club;
    
    # SSLÈÖçÁΩÆ
    ssl_certificate /etc/ssl/certs/ssl-cert-snakeoil.pem;
    ssl_certificate_key /etc/ssl/private/ssl-cert-snakeoil.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    
    # CloudflareÁúüÂÆûIP
    real_ip_header CF-Connecting-IP;
    set_real_ip_from 0.0.0.0/0;
    
    # LaravelÈ°πÁõÆ
    root $PUBLIC_DIR;
    index index.php index.html;
    
    # Â≠óÁ¨¶ÈõÜ
    charset utf-8;
    
    # Êó•Âøó
    access_log /var/log/nginx/besthammer.club_access.log;
    error_log /var/log/nginx/besthammer.club_error.log;
    
    # Laravel URLÈáçÂÜô
    location / {
        try_files \$uri \$uri/ /index.php?\$query_string;
    }
    
    # PHP 8.3-FPMÂ§ÑÁêÜ
    location ~ \.php$ {
        try_files \$uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        
        # ‰ΩøÁî®PHP 8.3-FPM socket
        fastcgi_pass unix:$PHP_SOCKET;
        fastcgi_index index.php;
        
        # FastCGIÂèÇÊï∞
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME \$realpath_root\$fastcgi_script_name;
        fastcgi_param DOCUMENT_ROOT \$realpath_root;
        
        # PHP 8.3ÁéØÂ¢ÉÂèòÈáè
        fastcgi_param PHP_VERSION 8.3;
        fastcgi_param HTTPS on;
        fastcgi_param APP_ENV production;
        
        # CloudflareÂ§¥
        fastcgi_param HTTP_CF_CONNECTING_IP \$http_cf_connecting_ip;
        fastcgi_param HTTP_X_FORWARDED_PROTO \$http_x_forwarded_proto;
        fastcgi_param HTTP_CF_RAY \$http_cf_ray;
        
        # PHP 8.3‰ºòÂåñÁöÑË∂ÖÊó∂ËÆæÁΩÆ
        fastcgi_connect_timeout 300;
        fastcgi_send_timeout 300;
        fastcgi_read_timeout 300;
        
        # PHP 8.3‰ºòÂåñÁöÑÁºìÂÜ≤ËÆæÁΩÆ
        fastcgi_buffer_size 128k;
        fastcgi_buffers 8 128k;
        fastcgi_busy_buffers_size 256k;
        fastcgi_temp_file_write_size 256k;
        
        # PHP 8.3ÂÜÖÂ≠ò‰ºòÂåñ
        fastcgi_max_temp_file_size 2048m;
    }
    
    # ÈùôÊÄÅÊñá‰ª∂Â§ÑÁêÜ
    location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Vary Accept-Encoding;
        try_files \$uri =404;
    }
    
    # ÂÆâÂÖ®ËÆæÁΩÆ
    location ~ /\. {
        deny all;
    }
    
    location ~ ^/(\.env|\.git|composer\.(json|lock)|artisan) {
        deny all;
    }
    
    # ÂÆâÂÖ®Â§¥
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options SAMEORIGIN;
    add_header X-XSS-Protection "1; mode=block";
    add_header Referrer-Policy "strict-origin-when-cross-origin";
}
EOF

# ÂêØÁî®ÈÖçÁΩÆ
ln -sf "$NGINX_CONFIG" "/etc/nginx/sites-enabled/besthammer.club"

# ÊµãËØïNginxÈÖçÁΩÆ
if nginx -t; then
    log_success "NginxÈÖçÁΩÆÊµãËØïÈÄöËøá"
else
    log_error "NginxÈÖçÁΩÆÊúâÈîôËØØ"
    nginx -t
    exit 1
fi

log_step "Á¨¨5Ê≠•ÔºöÈáçÂêØÊúçÂä°Âπ∂È™åËØÅ"
echo "-----------------------------------"

# ÈáçÂêØÊúçÂä°
systemctl restart "$PHP_SERVICE"
systemctl restart nginx

# È™åËØÅÊúçÂä°Áä∂ÊÄÅ
if systemctl is-active --quiet "$PHP_SERVICE"; then
    log_success "PHP 8.3-FPMËøêË°åÊ≠£Â∏∏"
else
    log_error "PHP 8.3-FPMÂêØÂä®Â§±Ë¥•"
    exit 1
fi

if systemctl is-active --quiet nginx; then
    log_success "NginxËøêË°åÊ≠£Â∏∏"
else
    log_error "NginxÂêØÂä®Â§±Ë¥•"
    exit 1
fi

log_step "Á¨¨6Ê≠•ÔºöÂàõÂª∫PHP 8.3ÊµãËØïÈ°µÈù¢"
echo "-----------------------------------"

cat > "$PUBLIC_DIR/php83-test.php" << 'EOF'
<?php
header('Content-Type: text/html; charset=utf-8');

$php_info = [
    'version' => PHP_VERSION,
    'sapi' => php_sapi_name(),
    'extensions' => get_loaded_extensions(),
    'memory_limit' => ini_get('memory_limit'),
    'max_execution_time' => ini_get('max_execution_time'),
    'upload_max_filesize' => ini_get('upload_max_filesize'),
    'post_max_size' => ini_get('post_max_size')
];

$laravel_compatible = version_compare(PHP_VERSION, '8.1.0', '>=');
?>
<!DOCTYPE html>
<html>
<head>
    <title>PHP 8.3-FPMÊµãËØïÈ°µÈù¢</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .container { background: rgba(255,255,255,0.95); color: #333; padding: 40px; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); max-width: 1000px; margin: 0 auto; }
        .success { color: #28a745; font-weight: bold; font-size: 20px; }
        .info { color: #007bff; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .status-ok { background-color: #d4edda; }
        .badge { padding: 4px 8px; border-radius: 4px; color: white; font-size: 12px; font-weight: bold; }
        .badge-success { background-color: #28a745; }
        .badge-info { background-color: #007bff; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="success">üöÄ PHP 8.3-FPMÊµãËØïÊàêÂäüÔºÅ</h1>
        
        <div style="background: #d4edda; padding: 20px; border-radius: 10px; border-left: 5px solid #28a745; margin: 20px 0;">
            <h3 style="color: #155724; margin: 0 0 10px 0;">‚úÖ FastPanel PHP 8.3-FPMÈÖçÁΩÆÊ≠£Â∏∏</h3>
            <p style="color: #155724; margin: 0;">502ÈîôËØØÂ∑≤‰øÆÂ§çÔºåPHP 8.3‰∏éLaravel 10.xÂÆåÂÖ®ÂÖºÂÆπÔºÅ</p>
        </div>
        
        <h2>PHP 8.3‰ø°ÊÅØ</h2>
        <table>
            <tr><th>È°πÁõÆ</th><th>ÂÄº</th><th>Áä∂ÊÄÅ</th></tr>
            <tr class="status-ok">
                <td>PHPÁâàÊú¨</td>
                <td><?php echo $php_info['version']; ?></td>
                <td><span class="badge badge-success">‚úÖ 8.3</span></td>
            </tr>
            <tr class="status-ok">
                <td>SAPI</td>
                <td><?php echo $php_info['sapi']; ?></td>
                <td><span class="badge badge-success">‚úÖ FPM</span></td>
            </tr>
            <tr class="status-ok">
                <td>LaravelÂÖºÂÆπÊÄß</td>
                <td><?php echo $laravel_compatible ? 'ÂÆåÂÖ®ÂÖºÂÆπ' : '‰∏çÂÖºÂÆπ'; ?></td>
                <td><span class="badge badge-success">‚úÖ ÂÖºÂÆπ</span></td>
            </tr>
            <tr>
                <td>ÂÜÖÂ≠òÈôêÂà∂</td>
                <td><?php echo $php_info['memory_limit']; ?></td>
                <td><span class="badge badge-info">ÈÖçÁΩÆ</span></td>
            </tr>
            <tr>
                <td>ÊâßË°åÊó∂Èó¥ÈôêÂà∂</td>
                <td><?php echo $php_info['max_execution_time']; ?>Áßí</td>
                <td><span class="badge badge-info">ÈÖçÁΩÆ</span></td>
            </tr>
        </table>
        
        <h2>LaravelÊâ©Â±ïÊ£ÄÊü•</h2>
        <table>
            <tr><th>Êâ©Â±ï</th><th>Áä∂ÊÄÅ</th></tr>
            <?php
            $required_extensions = ['mbstring', 'openssl', 'pdo', 'tokenizer', 'xml', 'ctype', 'json', 'bcmath', 'curl', 'fileinfo'];
            foreach ($required_extensions as $ext) {
                $loaded = extension_loaded($ext);
                echo "<tr class='" . ($loaded ? 'status-ok' : '') . "'>";
                echo "<td>$ext</td>";
                echo "<td>" . ($loaded ? '<span class="badge badge-success">‚úÖ Â∑≤Âä†ËΩΩ</span>' : '<span class="badge badge-error">‚ùå Êú™Âä†ËΩΩ</span>') . "</td>";
                echo "</tr>";
            }
            ?>
        </table>
        
        <h2>ÂäüËÉΩÊµãËØï</h2>
        <div style="text-align: center; margin: 30px 0;">
            <a href="/" style="display: inline-block; margin: 10px; padding: 15px 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 25px; font-weight: bold;">üè† LaravelÈ¶ñÈ°µ</a>
            <a href="/en/" style="display: inline-block; margin: 10px; padding: 15px 25px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; text-decoration: none; border-radius: 25px; font-weight: bold;">üá∫üá∏ Ëã±ËØ≠ÁâàÊú¨</a>
        </div>
        
        <hr style="margin: 30px 0;">
        <p style="text-align: center; color: #6c757d;">
            <small>
                <strong>FastPanel + PHP 8.3-FPM + Laravel 10.x</strong><br>
                ÂÆåÁæéÂÖºÂÆπÔºåÈ´òÊÄßËÉΩËøêË°å
            </small>
        </p>
    </div>
</body>
</html>
EOF

# ËÆæÁΩÆÊñá‰ª∂ÊùÉÈôê
chown -R www-data:www-data "$PROJECT_DIR"
chmod -R 755 "$PROJECT_DIR"
chmod -R 775 "$PROJECT_DIR/storage"
chmod -R 775 "$PROJECT_DIR/bootstrap/cache"

log_success "PHP 8.3ÊµãËØïÈ°µÈù¢ÂàõÂª∫ÂÆåÊàê"

echo ""
echo "üéâ PHP 8.3-FPM‰∏ìÁî®‰øÆÂ§çÂÆåÊàêÔºÅ"
echo "============================="
echo ""
echo "üìã ÈÖçÁΩÆÊëòË¶ÅÔºö"
echo "‚úÖ PHPÁâàÊú¨: 8.3 (FastPanelÂÖºÂÆπ)"
echo "‚úÖ LaravelÁâàÊú¨: 10.x (ÂÆåÂÖ®ÂÖºÂÆπ)"
echo "‚úÖ Socket: $PHP_SOCKET"
echo "‚úÖ ÊúçÂä°Áä∂ÊÄÅ: Ê≠£Â∏∏ËøêË°å"
echo ""
echo "üß™ ‰∏ìÁî®ÊµãËØïÈ°µÈù¢Ôºö"
echo "   https://www.besthammer.club/php83-test.php"
echo ""
echo "üéØ Â¶ÇÊûúÊµãËØïÈ°µÈù¢ÊòæÁ§∫ÊàêÂäüÔºåËØ¥ÊòéÔºö"
echo "   - PHP 8.3-FPMÈÖçÁΩÆÊ≠£Á°Æ"
echo "   - Laravel 10.xÂÆåÂÖ®ÂÖºÂÆπ"
echo "   - 502ÈîôËØØÂ∑≤Ëß£ÂÜ≥"
echo "   - ÂèØ‰ª•Ê≠£Â∏∏‰ΩøÁî®ÊâÄÊúâÂäüËÉΩ"
echo ""
echo "üöÄ Êé•‰∏ãÊù•ÊµãËØïÔºö"
echo "   1. LaravelÈ¶ñÈ°µ: https://www.besthammer.club/"
echo "   2. Â§öËØ≠Ë®ÄË∑ØÁî±: https://www.besthammer.club/en/"
echo ""
log_info "PHP 8.3-FPM‰∏ìÁî®‰øÆÂ§çÂÆåÊàêÔºÅFastPanelÁéØÂ¢ÉÂÆåÂÖ®ÂÖºÂÆπÔºÅ"
